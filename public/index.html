<!DOCTYPE html>
<html lang="vi">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>HMAC Demo Client</title>
    <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/css/bootstrap.min.css" rel="stylesheet">
    <style>
        body { padding: 20px; background-color: #f8f9fa; }
        .card { margin-bottom: 20px; box-shadow: 0 2px 4px rgba(0,0,0,0.1); }
        pre { background: #2d2d2d; color: #f8f8f2; padding: 10px; border-radius: 4px; }
        .status-ok { color: green; font-weight: bold; }
        .status-fail { color: red; font-weight: bold; }
        @keyframes spin { 100% { transform: rotate(360deg); } }
        .spinning { animation: spin 1s linear infinite; }
    </style>
</head>
<body>
    <div class="container">
        <h1 class="mb-4 text-center">HMAC Security Demo</h1>
        
        <div class="row">
            <!-- Client Simulator Section -->
            <div class="col-md-6">
                <div class="card">
                    <div class="card-header bg-primary text-white">
                        <h5 class="mb-0">Client Simulator (Gửi Request)</h5>
                    </div>
                    <div class="card-body">
                        <div class="mb-3">
                            <label class="form-label">Secret Key (Shared Secret)</label>
                            <input type="text" id="secretKey" class="form-control" value="supersecretkey123">
                            <div class="form-text">Key này phải khớp với server để xác thực thành công.</div>
                        </div>

                        <div class="mb-3">
                            <label class="form-label">Dữ liệu giao dịch (Payload)</label>
                            <div class="input-group mb-2">
                                <span class="input-group-text">Action</span>
                                <input type="text" id="action" class="form-control" value="transfer">
                            </div>
                            <div class="input-group mb-2">
                                <span class="input-group-text">Amount</span>
                                <input type="number" id="amount" class="form-control" value="1000">
                            </div>
                            <div class="input-group mb-2">
                                <span class="input-group-text">Message</span>
                                <input type="text" id="message" class="form-control" value="Chuyển tiền ăn trưa">
                            </div>
                        </div>

                        <div class="form-check mb-3">
                            <input class="form-check-input" type="checkbox" id="autoFields" checked>
                            <label class="form-check-label" for="autoFields">
                                Tự động thêm Timestamp & Nonce (Chống Replay)
                            </label>
                        </div>

                        <div class="mb-3">
                            <label class="form-label">Preview JSON Body</label>
                            <textarea id="jsonPreview" class="form-control" rows="4" readonly></textarea>
                        </div>

                        <button id="btnSend" class="btn btn-success w-100">Gửi Request</button>
                    </div>
                </div>
            </div>

            <!-- Server Logs Section -->
            <div class="col-md-6">
                <div class="card h-100">
                    <div class="card-header bg-dark text-white d-flex justify-content-between align-items-center">
                        <h5 class="mb-0">Server Logs (Database)</h5>
                        <button id="btnRefresh" class="btn btn-sm btn-light" title="Làm mới">
                            <svg id="refreshIcon" xmlns="http://www.w3.org/2000/svg" width="16" height="16" fill="currentColor" viewBox="0 0 16 16">
                                <path fill-rule="evenodd" d="M8 3a5 5 0 1 0 4.546 2.914.5.5 0 0 1 .908-.417A6 6 0 1 1 8 2v1z"/>
                                <path d="M8 4.466V.534a.25.25 0 0 1 .41-.192l2.36 1.966c.12.1.12.284 0 .384L8.41 4.658A.25.25 0 0 1 8 4.466z"/>
                            </svg>
                        </button>
                    </div>
                    <div class="card-body p-0" style="max-height: 600px; overflow-y: auto;">
                        <table class="table table-striped table-hover mb-0">
                            <thead class="table-light sticky-top">
                                <tr>
                                    <th>Time</th>
                                    <th>Status</th>
                                    <th>Reason</th>
                                </tr>
                            </thead>
                            <tbody id="logTableBody">
                                <!-- Logs will be loaded here -->
                            </tbody>
                        </table>
                    </div>
                </div>
            </div>
        </div>
    </div>

    <!-- Response Modal -->
    <div class="modal fade" id="responseModal" tabindex="-1" aria-hidden="true">
        <div class="modal-dialog">
            <div class="modal-content">
                <div class="modal-header">
                    <h5 class="modal-title">Kết quả từ Server</h5>
                    <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Close"></button>
                </div>
                <div class="modal-body">
                    <div id="responseModalStatus" class="mb-3"></div>
                    <pre id="responseModalBody"></pre>
                </div>
                <div class="modal-footer">
                    <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Đóng</button>
                </div>
            </div>
        </div>
    </div>

    <!-- Payload Detail Modal -->
    <div class="modal fade" id="payloadModal" tabindex="-1" aria-hidden="true">
        <div class="modal-dialog modal-lg">
            <div class="modal-content">
                <div class="modal-header">
                    <h5 class="modal-title">Chi tiết Payload</h5>
                    <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Close"></button>
                </div>
                <div class="modal-body">
                    <pre id="modalPayloadContent"></pre>
                </div>
            </div>
        </div>
    </div>

    <script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/js/bootstrap.bundle.min.js" integrity="sha384-geWF76RCwLtnZ8qwWowPQNguL3RmwHVBC9FhGdlKrxdiJJigb/j/68SIy3Te4Bkz" crossorigin="anonymous"></script>
    <script>
        // Helper: Generate UUID
        function uuidv4() {
            return ([1e7]+-1e3+-4e3+-8e3+-1e11).replace(/[018]/g, c =>
                (c ^ crypto.getRandomValues(new Uint8Array(1))[0] & 15 >> c / 4).toString(16)
            );
        }

        // Helper: Compute HMAC-SHA256
        async function computeHMAC(secret, message) {
            const enc = new TextEncoder();
            const key = await crypto.subtle.importKey(
                'raw',
                enc.encode(secret),
                { name: 'HMAC', hash: { name: 'SHA-256' } },
                false,
                ['sign']
            );
            const signature = await crypto.subtle.sign('HMAC', key, enc.encode(message));
            return Array.from(new Uint8Array(signature))
                .map(b => b.toString(16).padStart(2, '0'))
                .join('');
        }

        // Update JSON Preview
        function updatePreview() {
            const action = document.getElementById('action').value;
            const amount = parseInt(document.getElementById('amount').value) || 0;
            const message = document.getElementById('message').value;
            const autoFields = document.getElementById('autoFields').checked;

            const payload = { action, amount, message };
            
            if (autoFields) {
                payload.timestamp = Math.floor(Date.now() / 1000);
                payload.nonce = uuidv4();
            }

            document.getElementById('jsonPreview').value = JSON.stringify(payload, null, 2);
            return JSON.stringify(payload);
        }

        // Event Listeners
        document.getElementById('action').addEventListener('input', updatePreview);
        document.getElementById('amount').addEventListener('input', updatePreview);
        document.getElementById('message').addEventListener('input', updatePreview);
        document.getElementById('autoFields').addEventListener('change', updatePreview);

        // Initial Preview
        updatePreview();

        // Send Request
        document.getElementById('btnSend').addEventListener('click', async () => {
            const secret = document.getElementById('secretKey').value;
            const body = updatePreview(); // Get fresh body with new timestamp/nonce if checked
            
            try {
                const hmac = await computeHMAC(secret, body);
                
                const res = await fetch('/api', {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/json',
                        'X-HMAC': hmac
                    },
                    body: body
                });

                const data = await res.json();
                
                const statusEl = document.getElementById('responseModalStatus');
                if (res.ok) {
                    statusEl.innerHTML = `<div class="alert alert-success mb-0"><strong>Thành công</strong> (${res.status})</div>`;
                } else {
                    statusEl.innerHTML = `<div class="alert alert-danger mb-0"><strong>Thất bại</strong> (${res.status})</div>`;
                }
                document.getElementById('responseModalBody').textContent = JSON.stringify(data, null, 2);
                
                const modal = new bootstrap.Modal(document.getElementById('responseModal'));
                modal.show();
                
                // Auto refresh logs
                loadLogs();

            } catch (err) {
                const statusEl = document.getElementById('responseModalStatus');
                statusEl.innerHTML = `<div class="alert alert-danger mb-0"><strong>Lỗi kết nối</strong></div>`;
                document.getElementById('responseModalBody').textContent = err.message;
                const modal = new bootstrap.Modal(document.getElementById('responseModal'));
                modal.show();
            }
        });

        // Load Logs
        async function loadLogs() {
            const icon = document.getElementById('refreshIcon');
            if(icon) icon.classList.add('spinning');
            
            try {
                const res = await fetch('/logs');
                const logs = await res.json();
                const tbody = document.getElementById('logTableBody');
                tbody.innerHTML = logs.map((log, index) => {
                    // Convert UTC time from server to Vietnam Time (UTC+7)
                    const date = new Date(log.created_at + 'Z'); // Append Z to treat as UTC
                    const timeStr = date.toLocaleTimeString('vi-VN', { hour12: false });
                    const dateStr = date.toLocaleDateString('vi-VN');
                    
                    // Store payload in a data attribute (encoded)
                    // encodeURIComponent does not encode single quotes, which breaks the onclick attribute
                    const payloadSafe = encodeURIComponent(log.payload).replace(/'/g, '%27');

                    return `
                    <tr style="cursor: pointer;" onclick="showPayload('${payloadSafe}')">
                        <td>
                            <div class="fw-bold">${timeStr}</div>
                            <small class="text-muted">${dateStr}</small>
                        </td>
                        <td>${log.ok ? '<span class="badge bg-success">OK</span>' : '<span class="badge bg-danger">FAIL</span>'}</td>
                        <td><small>${log.reason || '-'}</small></td>
                    </tr>
                `}).join('');
            } catch (err) {
                console.error('Failed to load logs', err);
            } finally {
                if(icon) icon.classList.remove('spinning');
            }
        }

        // Show Payload Modal
        function showPayload(encodedPayload) {
            try {
                const payloadStr = decodeURIComponent(encodedPayload);
                // Try to format JSON if possible
                let displayStr = payloadStr;
                try {
                    const obj = JSON.parse(payloadStr);
                    displayStr = JSON.stringify(obj, null, 2);
                } catch(e) {}

                document.getElementById('modalPayloadContent').textContent = displayStr;
                const modal = new bootstrap.Modal(document.getElementById('payloadModal'));
                modal.show();
            } catch (e) {
                console.error(e);
            }
        }

        document.getElementById('btnRefresh').addEventListener('click', loadLogs);
        
        // Initial load
        loadLogs();
    </script>
</body>
</html>
